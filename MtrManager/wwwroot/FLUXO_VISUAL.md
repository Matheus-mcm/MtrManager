# ?? Guia Visual - Como Funciona o Sistema

## Frontend ? Backend

### Visão Geral do Fluxo

```
???????????????????????????????????????????????????????????????????
?                         USUÁRIO FINAL                            ?
???????????????????????????????????????????????????????????????????
?  1. Seleciona Empresa                                            ?
?  2. Clica "Atualizar"                                            ?
?  3. Seleciona Período (datas)                                    ?
?  4. Visualiza Manifestos                                         ?
?  5. Clica em Manifesto para detalhes                             ?
?  6. Clica "Avançar" para processar                               ?
???????????????????????????????????????????????????????????????????
                             ?
???????????????????????????????????????????????????????????????????
?                    JAVASCRIPT (FRONTEND)                         ?
???????????????????????????????????????????????????????????????????
?  • CompanySearch: Dropdown de empresas                           ?
?  • DateRangeSelector: Seleção de datas                           ?
?  • Validação: intervalo máximo 30 dias                           ?
?  • Requisições HTTP (fetch)                                      ?
?  • Atualização de HTML/DOM                                       ?
???????????????????????????????????????????????????????????????????
                             ?
                    [HTTP Requests]
                    GET / POST
                             ?
???????????????????????????????????????????????????????????????????
?                 C# / ASP.NET CORE (BACKEND)                      ?
???????????????????????????????????????????????????????????????????
?  • ManifestoController                                           ?
?  • GET /Manifesto/GetByCnpj/{cnpj}?startDate=X&endDate=Y        ?
?  • POST /Manifesto/Update/{mtrNumero}                            ?
?  • Acesso a arquivos XML                                         ?
?  • Lógica de negócio                                             ?
???????????????????????????????????????????????????????????????????
                             ?
                      [JSON Response]
                             ?
        Frontend recebe dados e atualiza a tela
```

---

## Detalhamento das Chamadas HTTP

### 1?? GET Manifestos (Listar)

```
?? FRONTEND ??????????????????????????????????????????????????????
? companySearch.value = "EMPRESA XYZ - 12345678901234"            ?
? selectedDates = {                                               ?
?   startDate: "2024-01-01",                                      ?
?   endDate: "2024-01-31"                                         ?
? }                                                               ?
?                                                                 ?
? carregarManifestosComDatas("12345678901234")                    ?
??????????????????????????????????????????????????????????????????
                        ? (HTTP GET)
URL: /Manifesto/GetByCnpj/12345678901234
     ?startDate=2024-01-01
     &endDate=2024-01-31
                        ?
?? BACKEND ???????????????????????????????????????????????????????
? ManifestoController.Get(                                        ?
?   cnpj: "12345678901234",                                       ?
?   startDate: DateTime(2024, 1, 1),                              ?
?   endDate: DateTime(2024, 1, 31)                                ?
? )                                                               ?
?                                                                 ?
? 1. Limpar CNPJ                                                  ?
? 2. Procurar pasta: C:\...\12345678901234                        ?
? 3. Ler arquivos .xml                                            ?
? 4. Desserializar cada XML ? Manifesto object                    ?
? 5. Filtrar por data: dataEmissao >= startDate AND <= endDate    ?
? 6. Retornar List<Manifesto> como JSON                           ?
??????????????????????????????????????????????????????????????????
                        ? (JSON Response)
[
  {
    mtrNumero: "MTR000001",
    gerador: {
      razaoSocial: "EMPRESA A",
      dataEmissao: "2024-01-05"
    },
    residuos: [...]
  },
  {
    mtrNumero: "MTR000002",
    gerador: {
      razaoSocial: "EMPRESA A",
      dataEmissao: "2024-01-10"
    },
    residuos: [...]
  }
]
                        ?
?? FRONTEND ??????????????????????????????????????????????????????
? atualizarTabelaManifestos(manifestosArray)                      ?
? • Limpar tbody anterior                                         ?
? • Para cada manifesto:                                          ?
?   - Criar linha <tr>                                            ?
?   - Adicionar <td> com dados                                    ?
? • Inserir no DOM                                                ?
??????????????????????????????????????????????????????????????????
```

### 2?? POST Atualizar Manifesto

```
?? FRONTEND ??????????????????????????????????????????????????????
? window.currentMtr = "MTR000001"                                 ?
?                                                                 ?
? atualizarManifesto()                                            ?
? • Desabilitar botão                                             ?
? • Mostrar "Processando..."                                      ?
??????????????????????????????????????????????????????????????????
                   ? (HTTP POST)
URL: /Manifesto/Update/MTR000001
Method: POST
                   ?
?? BACKEND ???????????????????????????????????????????????????????
? ManifestoController.Update(mtrNumero: "MTR000001")              ?
?                                                                 ?
? try {                                                           ?
?   // TODO: Sua lógica aqui                                      ?
?   // - Atualizar database                                       ?
?   // - Mover arquivo                                            ?
?   // - Registrar em log                                         ?
?                                                                 ?
?   return Ok(new {                                               ?
?     success: true,                                              ?
?     message: "Atualizado com sucesso"                           ?
?   })                                                            ?
? }                                                               ?
? catch (ex) {                                                    ?
?   return BadRequest(new {                                       ?
?     success: false,                                             ?
?     message: ex.Message                                         ?
?   })                                                            ?
? }                                                               ?
??????????????????????????????????????????????????????????????????
                   ? (JSON Response)
{
  "success": true,
  "message": "Manifesto atualizado com sucesso",
  "mtrNumero": "MTR000001",
  "timestamp": "2024-01-20T14:30:00"
}
                   ?
?? FRONTEND ??????????????????????????????????????????????????????
? • Mudar texto botão para "? Sucesso!"                           ?
? • Mudar cor para verde                                          ?
? • Esperar 2 segundos                                            ?
? • Fechar modal                                                  ?
? • Restabelecer botão                                            ?
??????????????????????????????????????????????????????????????????
```

---

## Estrutura de Dados Esperada

### Resposta do GET /Manifesto/GetByCnpj/{cnpj}

```json
[
  {
    "mtrNumero": "MTR000001",
    "gerador": {
      "razaoSocial": "Empresa Geradora LTDA",
      "dataEmissao": "2024-01-15",
      "cnpj": "12.345.678/0001-00"
    },
    "transportador": {
      "razaoSocial": "Transportadora XYZ",
      "cnpj": "98.765.432/0001-99"
    },
    "destinador": {
      "razaoSocial": "Reciclagem ABC",
      "cnpj": "11.222.333/0001-44"
    },
    "residuos": [
      {
        "item": 1,
        "codigoIbamaDenominacao": "Óleo de motor usado",
        "classe": "II",
        "quantidade": "100",
        "unidade": "L",
        "estadoFisico": "Líquido",
        "onu": "UN3082",
        "tratamento": "Reciclagem",
        "acondicionamento": "Tambor de 200L",
        "observacao": "Segregado"
      }
    ]
  }
]
```

---

## Fluxo No Navegador (Console)

Quando tudo está funcionando, você vê isto no Console (F12):

```javascript
// Etapa 1: Abrir modal
console.log('Abrindo modal de datas')

// Etapa 2: Usuário seleciona datas e clica Aplicar
console.log('Datas selecionadas:', {
  startDate: "2024-01-01",
  endDate: "2024-01-31"
})

// Etapa 3: Carregando manifestos
console.log('Chamando backend: /Manifesto/GetByCnpj/12345678901234?startDate=2024-01-01&endDate=2024-01-31')

// Etapa 4: Resposta do backend
GET /Manifesto/GetByCnpj/12345678901234?startDate=2024-01-01&endDate=2024-01-31
Status: 200 OK
Response: Array(5) [ {...}, {...}, {...}, {...}, {...} ]

// Etapa 5: Atualizar tabela
console.log('Tabela atualizada com 5 manifestos')

// Se clicar "Avançar":
console.log('Atualizando manifesto:', 'MTR000001')

// Etapa 6: Resposta de atualização
POST /Manifesto/Update/MTR000001
Status: 200 OK
Response: {success: true, message: "Manifesto atualizado com sucesso", ...}

console.log('Modal fechado')
```

---

## ? Checklist para Você

- [ ] Ler o arquivo `ESTRUTURA_JAVASCRIPT.md` - entender como funciona
- [ ] Ler o arquivo `MUDANCAS_REALIZADAS.md` - ver o que mudou
- [ ] Copiar o código do `ManifestoController.cs.exemplo`
- [ ] Colar no seu `ManifestoController.cs` real
- [ ] Testar GET /Manifesto/GetByCnpj/{cnpj}?startDate=X&endDate=Y no Postman/Thunder
- [ ] Testar GET sem os parâmetros de data (deve funcionar também)
- [ ] Testar POST /Manifesto/Update/{mtrNumero} no Postman/Thunder
- [ ] Abrir navegador e testar o fluxo completo
- [ ] Abrir Console (F12) e conferir logs
- [ ] Conferir aba Network (F12) para ver as requisições

---

## ?? Se Algo Não Funcionar

### Frontend não faz requisição?
1. Abrir Console (F12)
2. Verificar se há erros vermelhos
3. Procurar por `console.log()` com mensagem de erro

### Backend não recebe as datas?
1. No Postman, testar:
   ```
   GET http://localhost:5000/Manifesto/GetByCnpj/12345678901234?startDate=2024-01-01&endDate=2024-01-31
   ```
2. Verificar se o backend está recebendo os parâmetros

### Resposta vazia do backend?
1. Verificar se a pasta existe: `C:\Users\act\Desktop\Mtrs\{cnpj}`
2. Verificar se há arquivos .xml na pasta
3. Verificar se os XMLs estão em formato correto

### Filtro de datas não funciona?
1. Verificar o formato da data no XML (deve ser string legível como DateTime)
2. Adicionar `Console.WriteLine()` no backend para debug
3. Usar Postman para testar

---

## ?? Resumo Técnico

| Aspecto | Detalhes |
|---------|----------|
| **Método HTTP GET** | Listar dados (sem body) |
| **Método HTTP POST** | Criar/Atualizar dados (com body) |
| **Formato de Data** | `YYYY-MM-DD` (ISO 8601) |
| **Separador Query** | `?` para primeiro parâmetro, `&` para os demais |
| **Resposta JSON** | Sempre com Content-Type: application/json |
| **Validação Frontend** | Máx 30 dias entre datas |
| **Validação Backend** | Verificar se arquivo XML existe e data é válida |

