
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8" />
    <title>Mtr Manager</title>
    <link rel="icon" href="assets/icon.png" />
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <div class="nav-bar">
        <img src="assets/logo.webp" alt="Logo Mtr Manager" />
        <button id="btnOpenCompanyManager" class="btn" title="Gerenciar Empresas">Empresas</button>
    </div>

    <div class="content">
        <div class="table-wrapper">
            <div class="filters">
                <div class="company-search-wrapper">
                    <input type="text"
                           id="companySearch"
                           class="company-search-input"
                           placeholder="Buscar empresa..."
                           autocomplete="off" />
                    <div id="companyDropdown" class="company-dropdown">
                        <div class="company-dropdown-list"></div>
                    </div>
                </div>
                <select id="companyList" style="display: none;">
                    <option value="0">Carregando...</option>
                </select>
                <button id="btnRefresh" class="btn btn-refresh" title="Atualizar manifestos">
                    <svg class="btn-refresh-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                        <path d="M21 3v5h-5"></path>
                        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                        <path d="M3 21v-5h5"></path>
                    </svg>
                    <span>Atualizar</span>
                </button>
            </div>

            <table id="manifestList" aria-label="Lista de manifestos">
                <thead>
                    <tr>
                        <th>Nº MTR</th>
                        <th>Gerador</th>
                        <th>Transportador</th>
                        <th>Destinador</th>
                        <th>Data Emissão</th>
                        <th>Resíduos</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="company-manager">

        </div>
    </div>

    <div class="modal-backdrop" id="backdrop" aria-hidden="true"></div>
    
    <!-- Modal de Notificação -->
    <div class="notification-modal" id="notificationModal" role="alert" aria-live="polite">
        <div class="notification-content">
            <div class="notification-header">
                <span class="notification-icon" id="notificationIcon">ℹ️</span>
                <h3 id="notificationTitle">Notificação</h3>
                <button class="btn notification-close" id="btnCloseNotification" aria-label="Fechar">✕</button>
            </div>
            <div class="notification-body">
                <p id="notificationMessage">Mensagem da notificação</p>
            </div>
            <div class="notification-footer">
                <button class="btn btn-primary" id="btnNotificationOk">Ok</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Seleção de Datas -->
    <div class="modal modal-lg" id="dateRangeModal" role="dialog" aria-modal="true" aria-labelledby="dateRangeModalLabel" tabindex="-1">
        <div class="modal-header">
            <h2 id="dateRangeModalLabel">Selecionar Período</h2>
            <button class="btn" id="btnCloseDateModal" aria-label="Fechar">✕</button>
        </div>
        <div class="modal-body">
            <div class="date-range-container">
                <div class="date-input-group">
                    <label for="dateStart">Data Início</label>
                    <input type="date" id="dateStart" class="date-input" required />
                    <span class="date-error" id="dateStartError"></span>
                </div>
                
                <div class="date-input-group">
                    <label for="dateEnd">Data Fim</label>
                    <input type="date" id="dateEnd" class="date-input" />
                    <span class="date-info" id="dateEndInfo"></span>
                    <span class="date-error" id="dateEndError"></span>
                </div>
                
                <div class="date-info-box">
                    <p><strong>Intervalo:</strong> <span id="dateInterval">-</span> dias</p>
                    <p class="date-note">Máximo de 30 dias permitido</p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" id="btnCancelDateModal">Cancelar</button>
            <button class="btn btn-primary" id="btnApplyDateRange">Aplicar</button>
        </div>
    </div>
    
    <!-- Modal de Detalhes do Manifesto -->
    <div class="modal modal-lg" id="pedidoModal" role="dialog" aria-modal="true" aria-labelledby="pedidoModalLabel" tabindex="-1" style="z-index: 1001;">
        <div class="modal-header">
            <h2 id="pedidoModalLabel">Detalhes do Manifesto (MTR)</h2>
            <button class="btn" id="btnClose" aria-label="Fechar">✕</button>
        </div>
        <div class="modal-body">
            <dl class="mtr-head">
                <dt>Nº MTR</dt>
                <dd id="m-mtr"></dd>
                <dt>Gerador</dt>
                <dd id="m-gerador"></dd>
                <dt>Transportador</dt>
                <dd id="m-transportador"></dd>
                <dt>Destinador</dt>
                <dd id="m-destinador"></dd>
                <dt>Data Emissão</dt>
                <dd id="m-emissao"></dd>
            </dl>

            <h3 class="modal-section-title">Resíduos</h3>
            <div id="m-residuos" class="residuos-groups"></div>
        </div>
        <div class="modal-footer">
            <button class="btn" id="btnCancel">Cancelar</button>
            <button class="btn btn-primary" id="btnAdvance">Avançar</button>
        </div>
    </div>

    <!-- Modal de Gerenciar Empresas -->
    <div class="modal modal-lg" id="companyManagerModal" role="dialog" aria-modal="true" aria-labelledby="companyManagerLabel" tabindex="-1">
        <div class="modal-header">
            <h2 id="companyManagerLabel">Gerenciar Empresas</h2>
            <button class="btn" id="btnCloseCompanyManager" aria-label="Fechar">✕</button>
        </div>
        <div class="modal-body">
            <div class="company-manager-container">
                <!-- Seção de formulário -->
                <div class="company-form-section" id="company-form-section">
                    <h3>Adicionar/Editar Empresa</h3>
                    <form id="companyForm" class="company-form">
                        <div class="form-group">
                            <label for="formCnpj">CNPJ *</label>
                            <input type="text" id="formCnpj" class="form-input" placeholder="00000000000000" maxlength="14" required />
                        </div>

                        <div class="form-group">
                            <label for="formRazaoSocial">Razão Social *</label>
                            <input type="text" id="formRazaoSocial" class="form-input" placeholder="Nome da empresa" required />
                        </div>

                        <div class="form-group">
                            <label for="formUnidade">Unidade *</label>
                            <input type="text" id="formUnidade" class="form-input" placeholder="Código da unidade" required />
                        </div>

                        <div class="form-group">
                            <label for="formCpf">CPF *</label>
                            <input type="text" id="formCpf" class="form-input" placeholder="00000000000" maxlength="11" required />
                        </div>

                        <div class="form-group">
                            <label for="formSenha">Senha *</label>
                            <input type="password" id="formSenha" class="form-input" placeholder="Senha SINIR" required />
                        </div>

                        <div class="form-group">
                            <label for="formAtivo">
                                <input type="checkbox" id="formAtivo" />
                                Ativa
                            </label>
                        </div>

                        <div class="form-actions">
                            <button type="button" id="btnFormCancel" class="btn">Cancelar</button>
                            <button type="submit" id="btnFormSubmit" class="btn btn-primary">Adicionar</button>
                        </div>
                    </form>
                </div>

                <!-- Seção de listagem -->
                <div class="company-list-section">
                    <h3>Empresas Cadastradas</h3>
                    <div class="company-list-container">
                        <table class="company-table" id="companyTable">
                            <thead>
                                <tr>
                                    <th>CNPJ</th>
                                    <th>Razão Social</th>
                                    <th>Unidade</th>
                                    <th>CPF</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="companyTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/Company/GetAll', { headers: { 'Accept': 'application/json' } })
                if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`)
                const companies = await response.json()

                // Set companies in search component
                companySearch.setCompanies(companies)
                document.getElementById('companySearch').placeholder = 'Selecione uma empresa...'

                // Also populate hidden select for backward compatibility
                const select = document.getElementById('companyList')
                select.innerHTML = '<option value="0">Selecione...</option>'
                companies.forEach(c => {
                    const o = document.createElement('option')
                    o.value = c.cnpj
                    o.textContent = `${c.unidade} - ${c.razaoSocial}`
                    select.appendChild(o)
                })
            } catch (err) {
                document.getElementById('companySearch').placeholder = 'Erro ao carregar empresas'
            }
        })
    </script>
</body>
</html>
